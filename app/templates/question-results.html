{% extends "base.html" %}
{% load static %}

{% block title %} Result {% endblock %}

{% block css %}
<style>
  .wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-left: 20%;
    padding-right: 20%;
  }

  p {
    max-width: 100%;
    word-wrap: break-word;
  }

  #graph-wrapper {
    width: 75%;
    margin-bottom: 20px;
  }

  @media only screen and (max-width: 800px) {
    .wrapper {
      padding: 10px;
    }

    #graph-wrapper {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="wrapper">
  <p>{{ data.title }}</p>
  <p style="font-size: 10pt;">{{ data.body | linebreaksbr }}</p>

  <div id="graph-wrapper">
    <canvas id="chart" height="250"></canvas>
  </div>

  {% if data.user_id != request.user.id %}
  <button id="followBtn" class="btn primary-bg center-btn">
    {% if data.id in data.user_followed_ids %}Following{% else %}Follow{% endif %}
  </button>
  {% endif %}
</div>
{% endblock %}

{% block js %}
{{ data|json_script:'data' }}
<script type="text/javascript" src="{% static 'js/Chart.min.js' %}"></script>
<script>
  const data = JSON.parse(document.getElementById('data').textContent);

  function formatLabel(labelText) {
    const lineLen = 4;
    const split = labelText.split(' ');
    if (split.length < lineLen) {
      return labelText;
    } else {
      const arr = [];
      for (let i = 0; i < split.length; i += lineLen) {
        arr.push(split.slice(i, i+lineLen).join(' '));
      }
      return arr;
    }
  }

  const ctx = document.getElementById("chart").getContext("2d");
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.choices.map(d => formatLabel(d.text)),
      datasets: [{
        label: 'Choice Counts',
        data: data.choices.map(d => d.count),
        backgroundColor: [
          'rgba(255, 99, 132, 0.2)',
          'rgba(255, 159, 64, 0.2)',
          'rgba(255, 205, 86, 0.2)',
          'rgba(75, 192, 192, 0.2)'
        ],
        borderColor: [
          'rgb(255, 99, 132)',
          'rgb(255, 159, 64)',
          'rgb(255, 205, 86)',
          'rgb(75, 192, 192)',
        ],
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        yAxes: [{
          ticks: {
            beginAtZero: true
          }
        }]
      }
    },
  });
</script>
<script>
  followBtn = document.getElementById("followBtn");
  const isFollowing = data.user_followed_ids.includes(data.id);

  if (followBtn) {
    if (isFollowing) {
      followBtn.addEventListener("click", async () => {
        const response = await fetch(`/api/questions/${data.id}/unfollow_question`);
        if (response.ok) {
          followBtn.innerText = "Follow";
        }
      });
    } else {
      followBtn.addEventListener("click", async () => {
        const response = await fetch(`/api/questions/${data.id}/follow_question`);
        if (response.ok) {
          followBtn.innerText = "Following";
        }
      });
    }
  }
</script>
{% endblock %}
